Implementing References

* General Strategy
** For now the dynamic semantics choice for references will be mutually exclusive compiler flag
** Syntax 
expr := (ref expr) (deref expr [str]) (set expr expr [str])
type := (Ref type)
** Need to modify parser, typechecker, cast insertion, passes that implement cast semantics
*** The largest forseen challanges are typechecker and the pass that lowers casts

** Consistency
       T₁ ∼ T₂
—————————————————————–
 (Ref T₁) ∼ (Ref T₂)

** Type Rules per Herman and Siek
[T-Ref-T]
    Γ ⊢ e : T
——————————————–——–
 Γ ⊢ (ref e) : (Ref T) 

[T-Deref-Ref-T]
 Γ ⊢ e : (Ref T)
——————————————–——–
 Γ⊢ (deref e l) : T

[T-Deref-Dyn]
 Γ ⊢ e : *
——————————————–——–
 Γ⊢ (deref e l) : *

[T-Set-Ref-T]
    Γ⊢ e₁ : Ref T₁   Γ ⊢ e₂ : T₂   T₂ ∼ T₁  
——————————————–——–——————————————–——–———————————
            Γ⊢ (set e₁ e₂ l) : T₁

[T-Set-Dyn]
    Γ⊢ e₁ : *   Γ ⊢ e₂ : T
————————————————————–——–———————————
    Γ⊢ (set e₁ e₂ l) : T

* Guarded
** Compilation

[C-Ref]
    E ⊢ e₁ ↝ e₂ : T
——————————————–——–——
 E ⊢ (ref e) ↝ (ref e₂) : Ref T 

[C-Deref-Ref-T]
    E ⊢ e₁ ↝ e₂ : Ref T
——————————————–——–————————–
E ⊢ (deref e₁ l) ↝ (deref e₂) : T

[C-Deref-Dyn] The definintion in Herman relies on UD 
    E ⊢ e₁ ↝ e₂ : Dyn
——————————————————————————–—————————————————————————
 E (deref e₁ l) -> (deref (cast e₂ Dyn (Ref Dyn) l))   ?!?!?!

[C-Set-Ref-T]
  E ⊢ e₁ ↝ e₃ : Ref T₁   E ⊢ e₂ ↝ e₄ : T₂  
————————————————————–——–————————————–——–———————————
  E ⊢ (set e₁ e₂ l) ↝ (set e₃ (cast e₄ T₂ T₁ l)) T₁

[C-Set-Dyn] Again Relying on UD for an easier semantics
              E ⊢ e₁ ↝ e₃ : Dyn        E ⊢ e₂ ↝ e₄ : T  
—————————————–—————————–——–————————————–——–————————————————————–——–——————————
  E ⊢ (set e₁ e₂ l) ↝ (set (cast e₃ Dyn (Ref Dyn) l) (cast e₄ T Dyn l)) : T
  


* Monotonic

* Then generalize to arrays.

* Stuff talked about in meeting.

Right about this right away
...
(lambda ...) <i -> Fail> ----> (eager)  error
(lambda ...) <i -> Fail> ----> (lazy)   call function; then error

need to change cast application to that shown in picture because
it is necisarry in order to maintain the gradual guarentee


